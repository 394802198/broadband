<. if (invoicePage.results != null && invoicePage.results.length > 0) { .>
<table class="table">
<. for (var o = 0, len = orderIds.length; o < len; o++){ .>
	<thead>
		<tr>
			<th colspan="11">
				<!-- In the external page, assign orderIds as obj's attribute -->
				<h3 class="text-success" style="margin: 2px;"><strong>Order Serial:&nbsp;<small><.=orderIds[o].></small></strong></h3>
			</th>
		</tr>
		<tr>
			<th>Reference</th>
			<th>Create Date</th>
			<th>Due Date</th>
			<th>Payable</th>
			<th>Credit</th>
			<th>Paid</th>
			<th>Balance</th>
			<th>Status / Defray Way</th>
			<th>&nbsp;</th>
			<th>&nbsp;</th>
		</tr>
	</thead>
	<tbody>
		<.
			for (var i = 0, invoiceLen = invoicePage.results.length; i < invoiceLen; i++) {
				var invoice = invoicePage.results[i];
				
				if(orderIds[o]==invoice.order_id){
				
					for (var t = transactionsList.length-1; t >= 0; t--) {
						var tx = transactionsList[t];
						
						if(tx.invoice_id==invoice.id){
							var txAmount_paid = new Number(tx.amount);
		.>
							<tr class="success">
								<td>Transaction# - <.= tx.id .></td>
								<td><.= tx.transaction_date_str .></td>
								<td>&nbsp;</td>
								<td>&nbsp;</td>
								<td>&nbsp;</td>
								<td><strong>-<.= txAmount_paid.toFixed(2) .></strong></td>
								<td>&nbsp;</td>
								<td style="text-align:center;"><strong><.= tx.card_name .></strong></td>
								<. if(tx.executor == null){ .>
									<td>&nbsp;</td>
									<td>&nbsp;</td>
								<. } else { .>
									<.
										for(var u=0; u<users.length; u++){
									   		if(users[u].id == tx.executor){
									.>
										<td>Executed By</td>
										<td><.= users[u].user_name .> -<br/><.= users[u].user_role .></td>
									<.
									   		}
										}
									.>
								<. } .>
							</tr>
		<.
						}
					}
		.>
					<tr class="<.= (invoice.status=='unpaid' || invoice.status=='not_pay_off') ? 'danger' : 
									invoice.status=='discard' ? 'info' : '' .>" >
					<td>Invoice# - <.= invoice.id .></td>
					<td><.= invoice.create_date_str .></td>
		<.
					if(invoice.status!='unpaid' && invoice.status!='not_pay_off'){
		.>
						<td>&nbsp;</td>
		<.
					} else {
		.>
						<td><strong style="color:red;"><.= invoice.due_date_str .></strong></td>
		<.
					}
					var invoiceAmount_payable = new Number(invoice.amount_payable);
					var invoiceCredit_back = new Number(invoice.amount_payable - invoice.final_payable_amount);
					var invoiceAmount_paid = new Number(invoice.amount_paid);
					var invoiceBalance = new Number(invoice.balance);
		.>
					<td><strong><.= invoiceAmount_payable.toFixed(2) .></strong></td>
					<td><strong>-<.= invoiceCredit_back.toFixed(2) .></strong></td>
					<td><strong>-<.= invoiceAmount_paid.toFixed(2) .></strong></td>
					<td><strong><.= invoiceBalance.toFixed(2) .></strong></td>
					<td><strong><.= invoice.status .></strong></td>
		<. 
					if((invoice.status=='unpaid' || invoice.status=='not_pay_off')
					&& (user_role=='administrator' || user_role=='system-developer' || user_role=='accountant')){
		.>
					<td>
						<div class="btn-group">
							<. if(invoice.payment_status == 'pending'){ .>
								<button type="button" class="btn btn-warning btn-xs" data-name="make_payment_<.= invoice.id .>">Pending</button>
								<button type="button" class="btn btn-warning btn-xs dropdown-toggle" data-toggle="dropdown">
									<span class="caret"></span>
								</button>
							<. } else { .>
								<button type="button" class="btn btn-primary btn-xs" data-name="make_payment_<.= invoice.id .>">Make Payment</button>
								<button type="button" class="btn btn-primary btn-xs dropdown-toggle" data-toggle="dropdown">
									<span class="caret"></span>
								</button>
							<. } .>
							<ul class="dropdown-menu" role="menu">
								<li><a href="<.= ctx .>/broadband-user/crm/customer/invoice/payment/credit-card/<.= invoice.id .>"><span class="glyphicon glyphicon-link"></span>&nbsp;&nbsp;DPS</a></li>
								<li><a href="#"><span class="glyphicon glyphicon-link"></span>&nbsp;&nbsp;Paypal</a></li>
								<li class="divider"></li>
								<li><a href="javascript:void(0);" id="<.= invoice.id .>" data-name="pay_way_by_<.= invoice.id .>" data-way="credit-card" ><span class="glyphicon glyphicon-credit-card"></span>&nbsp;&nbsp;Credit Card</a></li>
								<li><a href="javascript:void(0);" id="<.= invoice.id .>" data-name="pay_way_by_<.= invoice.id .>" data-way="a2a" ><span class="glyphicon glyphicon-transfer"></span>&nbsp;&nbsp;Account2Account</a></li>
								<li><a href="javascript:void(0);" id="<.= invoice.id .>" data-name="pay_way_by_<.= invoice.id .>" data-way="ddpay" ><span class="glyphicon glyphicon-share-alt"></span>&nbsp;&nbsp;DDPay</a></li>
								<li><a href="javascript:void(0);" id="<.= invoice.id .>" data-name="pay_way_by_<.= invoice.id .>" data-way="cash" ><span class="glyphicon glyphicon-usd"></span>&nbsp;&nbsp;Cash</a></li>
								<li><a href="javascript:void(0);" id="<.= invoice.id .>" data-name="pay_way_by_<.= invoice.id .>" data-way="voucher" ><span class="glyphicon glyphicon-tags"></span>&nbsp;&nbsp;Voucher</a></li>
								<li class="divider"></li>
								<li><a href="javascript:void(0);" id="<.= invoice.id .>" data-name="pay_way_by_<.= invoice.id .>" data-way="pending" ><span class="glyphicon glyphicon-pause"></span>&nbsp;&nbsp;Pending</a></li>
							</ul>
						</div>
					</td>
		<.
					} else {
		.>
					<td>&nbsp;</td>
		<. 
					}
					var downloadUrl = ctx+'/broadband-user/crm/customer/invoice/pdf/download/' + invoice.id;
					var sendUrl = ctx+'/broadband-user/crm/customer/invoice/pdf/send/' + invoice.id + '/' + customer_id;
					if((invoice.status=='unpaid' || invoice.status=='not_pay_off')
					&& (user_role=='administrator' || user_role=='system-developer' || user_role=='accountant')){
						if(invoice.invoice_pdf_path != null){
		.>
						<td>
							<!-- regenerate icon -->
							<a target="_blank" href="javascript:void(0);" id="<.= invoice.id .>" data-name="generateUrl_<.= invoice.id .>" data-toggle="tooltip" data-placement="bottom" data-original-title="regenerate invoice PDF" style="font-size:22px;"><span class="glyphicon glyphicon-refresh"></span></a>&nbsp;
							<!-- download icon -->
							<a target="_blank" href="<.= downloadUrl .>" id="<.= invoice.id .>" data-toggle="tooltip" data-placement="bottom" data-original-title="download invoice PDF"><span class="glyphicon glyphicon-floppy-disk" style="font-size:22px;"></span></a>&nbsp;
							<!-- download icon -->
							<a target="_blank" href="<.= sendUrl .>" id="<.= invoice.id .>" data-toggle="tooltip" data-placement="bottom" data-original-title="send invoice details to customer's email" style="font-size:22px;"><span class="glyphicon glyphicon-send"></span></a>
						</td>
		<.
						} else {
		.>
						<td>
							<!-- regenerate icon -->
							<a target="_blank" href="javascript:void(0);" id="<.= invoice.id .>" data-name="generateUrl_<.= invoice.id .>" data-toggle="tooltip" data-placement="bottom" data-original-title="regenerate invoice PDF" style="display:none;font-size:22px;"><span class="glyphicon glyphicon-refresh"></span></a>&nbsp;&nbsp;&nbsp;
							<!-- download icon -->
							<a target="_blank" href="<.= downloadUrl .>" id="<.= invoice.id .>" data-toggle="tooltip" data-placement="bottom" data-original-title="download invoice PDF" style="display:none;font-size:22px;"><span class="glyphicon glyphicon-floppy-disk"></span></a>&nbsp;&nbsp;&nbsp;
							<!-- download icon -->
							<a target="_blank" href="<.= sendUrl .>" id="<.= invoice.id .>" data-name="send_<.= invoice.id .>" data-toggle="tooltip" data-placement="bottom" data-original-title="send invoice details to customer's email" style="display:none;font-size:22px;"><span class="glyphicon glyphicon-send"></span></a>
							<a target="_blank" href="javascript:void(0);" id="<.= invoice.id .>" data-name="firstGenerate_<.= invoice.id .>" data-toggle="tooltip" data-placement="bottom" data-original-title="generate invoice PDF" style="font-size:22px;"><span class="glyphicon glyphicon-hdd"></span></a>
						</td>
		<.
						}
					} else {
						if(user_role=='administrator' || user_role=='system-developer' || user_role=='accountant'){
		.>
					<td>
						<!-- regenerate icon -->
						<a target="_blank" href="javascript:void(0);" id="<.= invoice.id .>" data-name="generateUrl_<.= invoice.id .>" data-toggle="tooltip" data-placement="bottom" data-original-title="regenerate invoice PDF"><span class="glyphicon glyphicon-refresh"></span></a>&nbsp;&nbsp;&nbsp;
						<!-- download icon -->
						<a target="_blank" href="<.= downloadUrl .>" data-toggle="tooltip" data-placement="bottom" data-original-title="download invoice PDF"><span class="glyphicon glyphicon-floppy-disk"></span></a>&nbsp;&nbsp;&nbsp;
					</td>
		<.
						} else {
		.>
					<td>&nbsp;</td>
		<.
						}
					}
		.>
				</tr>

		<. } .>
		
		<!-- regenerateInvoice Modal -->
		<div class="modal fade" id="regenerateInvoiceModal_<.= invoice.id .>" data-id="<.= invoice.id .>" tabindex="-1" role="dialog" aria-labelledby="regenerateInvoiceModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="regenerateInvoiceModalLabel">
							<strong>Regenerate this invoice?</strong>
						</h4>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<p>
								<strong>This operation will regenerate this selected invoice's PDF.</strong>
							</p>
						</div>
					</div>
					<div class="modal-footer">
						<a href="javascript:void(0);" class="btn btn-success col-md-12" data-name="regenerateInvoiceBtn_<.= invoice.id .>" id="<.= invoice.id .>" data-dismiss="modal"><strong>Confirm to regenerate this invoice</strong></a>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal-dialog -->
		</div>
		<!-- /.modal -->
		
		<!-- confirmPayWay Modal -->
		<div class="modal fade" id="confirmPayWayModal_<.= invoice.id .>" data-id="<.= invoice.id .>" tabindex="-1" role="dialog" aria-labelledby="confirmPayWayModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="confirmPayWayModalLabel">
							<strong data-name="confirm_payway_modal_title_<.= invoice.id .>"></strong>
						</h4>
					</div>
					<div class="modal-body">
						<div class="form-group" style="display:none;" data-name="cash_defray_amount_input_<.= invoice.id .>">
							<label for="defray_amount" class="control-label col-md-6">Defray Amount:</label>
							<div class="col-md-6">
								<input name="defray_amount_<.= invoice.id .>" value="<.= invoiceBalance.toFixed(2) .>" class="form-control input-sm" type="text" placeholder="Defray Amount"/>
							</div>
						</div>
						<div class="form-group" style="display:none;" data-name="vouchar_pin_number_input_<.= invoice.id .>">
							<label for="pin_number" class="control-label col-md-6">Pin Number:</label>
							<div class="col-md-6">
								<input id="pin_number" name="pin_number_<.= invoice.id .>" class="form-control input-sm" type="text" placeholder="Pin Number"/>
							</div>
						</div>
						<br/>
						<div class="form-group">
							<p>
								<strong data-name="confirm_payway_modal_content_<.= invoice.id .>"></strong>
							</p>
						</div>
					</div>
					<div class="modal-footer">
						<a href="javascript:void(0);" class="btn btn-success col-md-12" data-name="confirm_payway_modal_btn_<.= invoice.id .>" id="<.= invoice.id .>" data-dismiss="modal"></a>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal-dialog -->
		</div>
		<!-- /.modal -->
		
	<. } .>
<. } .>
	</tbody>
	<tfoot>
		<tr>
			<td colspan="11">
				<ul class="pagination">
	<.
					for (var i = 1, len = invoicePage.totalPage; i <= len; i++) {
	.>
						<li class="<.= invoicePage.pageNo == i ? 'active' : '' .>">
							<a href="javascript:void(0);" data-pageNo="<.=i.>" style="cursor:pointer;"><.=i.></a>
						</li>
	<.
					}
	.>
				</ul>
			</td>
		</tr>
	</tfoot>
</table>

<. } else { .>
	<div class="alert alert-warning">No records have been found.</div>
<. } .>
